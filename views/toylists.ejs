<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop Page</title>
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="shortcut icon" href="/images/lemontoyslogo.jpeg" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: Comfortaa, sans-serif;
            color: #171717;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            /* border: 1px solid black; */
        }

        .category,
        .filter,
        .popular {
            /* margin: 20px 85px; */
            padding: 10px;
            border: 1px solid white;
            border-radius: 8px;
            width: 200px;
            box-shadow: rgba(212, 59, 59, 0.2) 0px 2px 8px 0px;
        }

        .filter {
            width: 174px;
        }

        .category {
            width: 160px;
        }

        #changeByCategory {
            margin-left: 25px;
        }

        .dollor {
            display: flex;
            justify-content: space-between;
        }

        .button {
            display: flex;
            justify-content: right;
        }

        .btn {
            background-color: #0F83B2;
            color: white;
            border-radius: 4px;
            padding: 8px;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #0d6fa1;
        }

        .section {
            display: flex;
            padding: 20px;
            width: 300px;
            margin: auto;
        }

        .main {
            border: 1px solid black;
            width: 35%;
            height: 306px;
            margin: auto;
            padding: 16px 24px;
            align-items: center;
        }

        .ims {
            width: 260px;
            /* border: 1px solid black; */
            padding: 8px;
            box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
            border-radius: 20px;
        }

        .containers {
            /* border: 1px solid whitesmoke; */
            position: relative;
            /* width: 250px; */
            height: 200px;
            /* box-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px; */
            border-radius: 10px;
            display: flex;
        }

        .imageDiv {
            position: absolute;
            left: 3px;
            top: 4px;
            padding: 4px 8px;
            border-radius: 22px;
            background: red;
            color: whitesmoke;
            border: none;
            font-weight: 600;
            height: 30px;
            width: 65px;
        }

        .icons {
            position: absolute;
            top: 4px;
            right: 2px;
        }

        .icons i {
            margin-left: 5px;
            cursor: pointer;
        }

        .icons i:hover {
            color: red;
        }

        .h {
            display: flex;
            gap: 4px;
            align-items: center;
            margin-top: 15px;
        }

        .stars {
            color: orangered;
        }

        .right {
            width: 100%;
            margin-top: 30px;
            margin-left: 22px;
        }

        .toys {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
        }

        .productlistimg {
            width: 100%;
            height: 100%;
            /* object-fit: cover; */
            border-radius: 10px;
        }

        .category-dropdown {
            width: 145px;
            padding: 6px;
            border-radius: 6px;
            font-size: 14px;
        }


        .p {
            text-decoration: line-through;
        }




        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            gap: 10px;
            padding: 20px;
        }

        .page-link {
            color: black;
            text-decoration: none;
            font-size: 16px;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            transition: background 0.3s ease-in-out;
        }

        .page-link:hover {
            background-color: #e0e0e0;
        }

        .active {
            background-color: #0066ff;
            color: white;
            font-weight: bold;
            border: none;
            padding: 12px 18px;
        }

        .ellipsis {
            padding: 10px;
            font-size: 16px;
            color: #777;
        }



        /* .image-container {
            cursor: pointer;
        } */

        .qr-code {
            /* border: 1px solid black; */
            height: 60px;
            width: 60px;
            /* margin: auto; */
        }

        .qrcode {
            height: 100%;
            width: 100%;
        }

        .viewDetails {
            text-decoration: none;
            /* border: 1px solid; */
            background-color: red;
            color: white;
            padding: 3px;
            border-radius: 9px;
            font-size: 13px;
        }

        @media screen and (max-width: 1250px) {
            .container {
                flex-direction: column;
            }

            .left {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .ims {
                width: 100%;
                max-width: 260px;
            }

            .icons {
                top: 4px;
                right: 2px;
            }

            .productlistimg {
                width: 217px;
            }
        }

        @media screen and (max-width: 480px) {
            .container {
                flex-direction: column;
            }

            .left {
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .ims {
                width: 100%;
                max-width: 260px;
            }

            .icons {
                top: 4px;
                right: 2px;
            }

            .productlistimg {
                width: 120px;
            }
        }
    </style>
    <style>
        .category-dropdown-container {
            position: relative;
        }

        .whatsapp {
            /* border: 1px solid black; */
            height: 50px;

            /* margin-left: 20px; */
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .whatsapp>i {
            font-size: 35px;
            margin-top: 7px;

        }

        .whatsapp>input {
            padding-top: 10px;
            padding-bottom: 10px;
            border-radius: 15px;
            border: none;
            box-shadow: rgba(0, 0, 0, 0.02) 0px 1px 3px 0px, rgba(27, 31, 35, 0.15) 0px 0px 0px 1px;
            padding-left: 20px;
        }

        .search-icon {
            /* border: 1px solid black; */
            height: 35px;
            width: 35px;
            border-radius: 50%;
            position: relative;
            background: #0F83B2;
            right: 35px;
        }

        .search-icon>i {
            font-size: 20px;
            margin-left: 8px;
            margin-top: 7px;
            color: white;
        }

        .category-dropdown-toggle {
            cursor: pointer;
            border: 1px solid #ccc;
            padding: 6px;
            border-radius: 6px;
            background-color: #f9f9f9;
            font-size: 14px;
        }

        .category-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            max-height: 250px;
            overflow-y: auto;
            box-shadow: rgba(0, 0, 0, 0.16) 0px 2px 6px;
            padding: 10px;
            border-radius: 8px;
            margin-top: 5px;
            z-index: 999;
        }

        .category-dropdown-container.active .category-dropdown-content {
            display: block;
        }

        .category-dropdown-content label {
            font-size: 14px;
        }

        .category-dropdown-content .btn {
            margin-top: 10px;
            width: 100%;
        }
    </style>
</head>

<body>
    <%- include('common/navbar.ejs') %>
        <div class="container">
            <div class="left">
                <div class="category">
                    <h3>Product Categories</h3>
                    <hr>
                    <div class="category-dropdown-container">
                        <div class="category-dropdown-toggle category-dropdown" id="categoryToggle">
                            Select Categories
                        </div>

                        <div class="category-dropdown-content" id="categoryList">
                            <% allCategories.forEach(cat=> { %>
                                <label>
                                    <input type="checkbox" class="category-checkbox" value="<%= cat %>">
                                    <%= cat %>
                                </label><br>
                                <% }) %>
                                    <button id="applyCategoryFilter" class="btn">Apply</button>
                        </div>
                    </div>
                </div>

                <div class="filter">
                    <h3>Filter by Price</h3>

                    <label for="minRange">Min Price</label>
                    <input type="range" id="minRange" name="minRange" min="1" max="5000" value="1" />

                    <label for="maxRange">Max Price</label>
                    <input type="range" id="maxRange" name="maxRange" min="1" max="5000" value="5000" />

                    <div class="dollor">
                        <p id="minPrice">RS: 1.00</p>
                        <p id="maxPrice">RS: 5000.00</p>
                    </div>

                    <br>
                    <div class="button">
                        <button id="btn" class="btn">Apply</button>
                    </div>
                </div>
            </div>

            <div class="right">
                <h2 id="changeByCategory">Views All Toys</h2>
                <div class="whatsapp " style="margin-left: 50px;">
                    <input id="txt" type="search" placeholder="Search">
                </div>
                <br>
                <!-- this is showing total products of this webstie day 30-04-2025 time 16.55 -->
                <div>
                    <h3>Showing <%= alltoys.length %> Products</h3>
                </div>
                <!-- this is showing total products of this webstie day 30-04-2025 time 16.55 -->
                <div class="toys" id="productsContainer">
                    <% getAllToys?.forEach(product=> { %>

                        <div class="ims">
                            <div class="containers">
                                <div class="image-container">
                                    <% if (product.ProductImageURL) { %>
                                        <img class="productlistimg" src="<%= product.ProductImageURL %>"
                                            alt="<%= product.ProductName %>">
                                        <% } else { %>
                                            <img class="productlistimg" src="https://via.placeholder.com/200"
                                                alt="No Image Available">
                                            <% } %>
                                                <!-- <button class="imageDiv">Sale</button> -->
                                </div>
                                <div class="icons">
                                    <button class="addToCardBtn" onclick='addToCart({
                                        _id: "<%= product._id %>",
                                        ProductName: "<%= product.ProductName %>",
                                        Price: "<%= product.Price %>",
                                        quantity: "<%= product.MinimumOrderQuantity %>",
                                        ProductImageURL: "<%= product.ProductImageURL %>",
                                        qrCodeUrl: "<%= product.qrCodeUrl %>"
                                    })'>
                                        <i class="fa fa-shopping-cart"></i>
                                    </button>
                                </div>

                            </div>

                            <div>
                                <h3>
                                    <%= product.ProductName %>
                                </h3>
                                <div class="qr-code">
                                    <img class="qrcode"
                                        src="<%= product.qrCodeUrl ? product.qrCodeUrl : 'data:image/png;base64,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' %>"
                                        alt="QR Code for <%= product.ProductName %>">
                                </div>
                                <div class="h">
                                    <div>
                                        <% const dynamicKey='Price' + Category; %>
                                            <% const basePrice=product.Price || 0; %>
                                                <% const dynamicPrice=product[dynamicKey] || 0; %>
                                                    <% const finalPrice=basePrice + dynamicPrice; %>
                                                        <% if (finalPrice) { %>
                                                            <h4 style="color: green; margin-bottom: 4px;">
                                                                ₹<%= Math.abs(finalPrice) %>
                                                            </h4>
                                                            <% } else { %>
                                                                <h4 style="color: red; margin-bottom: 4px;"> Price Not
                                                                    Available</h4>
                                                                <% } %>

                                                                    <span style="font-size: 14px; color: #333;">
                                                                        Minimum Order Quantity: <%=
                                                                            product.MinimumOrderQuantity || 'N/A' %>
                                                                    </span>
                                    </div>

                                </div>

                                <a class="viewDetails" href="/toydetails/<%= product._id %>">View Details</a>
                            </div>
                        </div>
                        <% }); %>
                </div>

                <!-- Loading indicator -->
                <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner"
                        style="width: 40px; height: 40px; margin: 0 auto; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;">
                    </div>
                    <p>Loading more products...</p>
                </div>

                <script>
                    let pageNum = <%= currentPage || 1 %>;
                    let totalPages = <%= totalPages %>;
                </script>

                <style>
                    @keyframes spin {
                        0% {
                            transform: rotate(0deg);
                        }

                        100% {
                            transform: rotate(360deg);
                        }
                    }
                </style>

            </div>
        </div>
        <!-- Example product button -->

        <%- include('common/footer.ejs') %>
</body>
<!-- <script>
    const searchInput = document.getElementById('txt');
    let productsContainer = document.getElementById('productsContainer');
    let loadingIndicator = document.getElementById('loadingIndicator');

    searchInput.addEventListener('keydown', async (event) => {
        if (event.key === 'Enter') {
            const query = searchInput.value.trim();
            if (!query) return;

            productsContainer.innerHTML = '';
            loadingIndicator.style.display = 'block';

            try {
                const url = `/search-product?query=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                const toys = await res.json();
                console.log(toys.toys)
                console.log(toys.Category)
                alert("Toys Category: " + toys.Category)
                loadingIndicator.style.display = 'none';

                if (!toys.toys.length) {
                    productsContainer.innerHTML = '<p>No products found.</p>';
                    return;
                }

                toys.toys.forEach(product => {
                    console.log("first", product)
                    const finalPrice = (product.Price || 0) + (product[`Price${toys.Category}`] || 0);
                    const image = product.ProductImageURL || 'https://via.placeholder.com/200';
                    const qrCode = product.qrCodeUrl || 'https://via.placeholder.com/80x80?text=QR';
                    const moq = product.MinimumOrderQuantity || 'N/A';

                    const productHTML = `
                        <div class="ims">
                            <div class="containers">
                                <div class="image-container">
                                    <img class="productlistimg" src="${image}" alt="${product.ProductName}">
                                    // <button class="imageDiv">Sale</button>
                                </div>
                                <div class="icons">
                                    <button class="addToCardBtn" onclick='addToCart(${JSON.stringify(product)})'>
                                        <i class="fa fa-shopping-cart"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h3>${product.ProductName}</h3>
                                <div class="qr-code">
                                    <img class="qrcode" src="${qrCode}" alt="QR Code for ${product.ProductName}">
                                </div>
                                <div class="h">
                                    <h4 style="color: green; margin-bottom: 4px;">₹${Math.abs(finalPrice)}</h4>
                                    <span style="font-size: 14px; color: #333;">Minimum Order Quantity: ${moq}</span>
                                </div>
                                <a class="viewDetails" href="/toydetails/${product._id}">View Details</a>
                            </div>
                        </div>
                    `;
                    productsContainer.innerHTML += productHTML;
                });

            } catch (error) {
                loadingIndicator.style.display = 'none';
                productsContainer.innerHTML = '<p>Something went wrong. Try again later.</p>';
                console.error('Search Error:', error);
            }
        }
    });
    // // Add to cart function (unchanged)
    // async function addToCart(product) {
    //     console.log("Product received in JS:", product);
    //     try {
    //         const response = await fetch('/add-to-cart', {
    //             method: 'POST',
    //             headers: {
    //                 'Content-Type': 'application/json'
    //             },
    //             body: JSON.stringify(product)
    //         });

    //         const result = await response.json();

    //         if (response.ok) {
    //             alert(`${product.ProductName} added to cart!`);
    //         } else {
    //             alert(result.message);
    //         }
    //     } catch (error) {
    //         console.error("Add to cart failed:", error);
    //         alert("Something went wrong!");
    //     }
    // }
    // window.addToCart = addToCart;


    document.getElementById("categoryToggle").addEventListener("click", function (e) {
        document.querySelector(".category-dropdown-container").classList.toggle("active");
    });



    // Price slider functionality (unchanged)
    const minPrice = document.getElementById("minPrice");
    const maxPrice = document.getElementById("maxPrice");
    const minSlider = document.getElementById("minRange");
    const maxSlider = document.getElementById("maxRange");

    // Update min price when sliding
    minSlider.addEventListener("input", function () {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);

        // Prevent min from exceeding max
        if (minVal > maxVal) {
            maxSlider.value = minVal;
            maxVal = minVal;
            maxPrice.textContent = "RS: " + maxVal + ".00";
        }

        minPrice.textContent = "RS: " + minVal + ".00";
    });

    // Update max price when sliding
    maxSlider.addEventListener("input", function () {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);

        // Prevent max from being less than min
        if (maxVal < minVal) {
            minSlider.value = maxVal;
            minVal = maxVal;
            minPrice.textContent = "RS: " + minVal + ".00";
        }

        maxPrice.textContent = "RS: " + maxVal + ".00";
    });

    // Apply button handler
    document.getElementById('btn').addEventListener('click', () => {
        let min = minSlider.value;
        let max = maxSlider.value;

        // Check if there's a category parameter in the current URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');

        // Build the redirect URL
        let redirectUrl = `/alltoys?min=${min}&max=${max}`;

        // Add category if it exists
        if (categoryParam) {
            redirectUrl += `&category=${categoryParam}`;
        }

        window.location.href = redirectUrl;
    });

    // Category functionality (unchanged)
    // Price filter button handler
    document.getElementById('btn').addEventListener('click', () => {
        let min = minSlider.value;
        let max = maxSlider.value;

        // Check if there's a category parameter in the current URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');

        // Build the redirect URL
        let redirectUrl = `/alltoys?min=${min}&max=${max}`;

        // Add category if it exists
        if (categoryParam) {
            redirectUrl += `&category=${categoryParam}`;
        }

        window.location.href = redirectUrl;
    });

    // Category filter button handler (using your existing code with modifications)
    const applyBtn = document.getElementById('applyCategoryFilter');
    const changeByCategory = document.getElementById('changeByCategory');

    applyBtn.addEventListener("click", (e) => {
        e.preventDefault();

        const selectedCategories = [];
        const checkboxes = document.querySelectorAll(".category-checkbox");

        checkboxes.forEach(cb => {
            if (cb.checked) {
                selectedCategories.push(cb.value);
            }
        });

        console.log(selectedCategories);

        // Get current min/max values if they exist
        const urlParams = new URLSearchParams(window.location.search);
        const minParam = urlParams.get('min');
        const maxParam = urlParams.get('max');

        let redirectUrl = '/alltoys/?';

        // Category parameters
        if (selectedCategories.length === 0) {
            redirectUrl += 'category=';
        } else {
            const categoryQuery = selectedCategories.join(',');
            changeByCategory.innerText = selectedCategories.join(', ');
            redirectUrl += `category=${encodeURIComponent(categoryQuery)}`;
        }

        // Add price parameters if they exist
        if (minParam && maxParam) {
            redirectUrl += `&min=${minParam}&max=${maxParam}`;
        }

        window.location.href = redirectUrl;
    });
    // Infinite scrolling implementation
    let pageNum = <%= JSON.stringify(currentPage || 1) %>;
    let totalPages = <%= JSON.stringify(totalPages) %>;
    
    console.log('Current Page:', pageNum);
    console.log('Total Pages:', totalPages);
    let isLoading = false;
    loadingIndicator = document.getElementById('loadingIndicator');
    productsContainer = document.getElementById('productsContainer');

    // Function to create product HTML
    function createProductHTML(product, Category) {
        console.log(Category)
        return `
        <div class="ims">
            <div class="containers">
                <div class="image-container">
                    ${product.ProductImageURL ?
                `<img class="productlistimg" src="${product.ProductImageURL}" alt="${product.ProductName}">` :
                `<img class="productlistimg" src="https://via.placeholder.com/200" alt="No Image Available">`}
                    <button class="imageDiv">Sale</button>
                </div>
                <div class="icons">
                    <button class="addToCardBtn" onclick='addToCart({
                        _id: "${product._id}",
                        ProductName: "${product.ProductName}",
                        Price: "${product.Price}",
                        quantity: "${product.MinimumOrderQuantity}",
                        ProductImageURL: "${product.ProductImageURL}",
                        qrCodeUrl: "${product.qrCodeUrl}"
                    })'>
                        <i class="fa fa-shopping-cart"></i>
                    </button>
                </div>
            </div>
            <div>
                <h3>${product.ProductName}</h3>
                <div class="qr-code">
                    <img class="qrcode" 
                        src="${product.qrCodeUrl ? product.qrCodeUrl : 'data:image/png;base64,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'}" 
                        alt="QR Code for ${product.ProductName}">
                </div>
                <div class="h" style="display: flex; flex-direction: column; gap: 4px;">
    <h3 style="${Category && product['Price' + Category] ? 'color:green;' : 'color:red;'} margin: 0;">
    ${Category && product['Price' + Category]
                ? '₹' + Math.abs(product['Price' + Category] + product.Price)
                : 'Price Not Available'}
</h3>

    <span style="font-size: 14px; color: #444;">MOQ: ${product.MinimumOrderQuantity}</span>
</div>

<a class="viewDetails" href="/toydetails/${product._id}">View Details</a>

            </div>
        </div>`;
    }

    // Function to load more products
    async function loadMoreProducts() {
        if (isLoading || pageNum >= totalPages) return;

        isLoading = true;
        loadingIndicator.style.display = 'block';

        try {
            // Get current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const price = urlParams.get('price') || '';
            const category = urlParams.get('category') || '';

            // Create URL for fetching next page
            const nextPage = pageNum + 1;
            const url = `/api/toys?page=${nextPage}&price=${price}&category=${category}`;

            const response = await fetch(url);

            if (!response.ok) {
                throw new Error('Failed to fetch more products');
            }

            const data = await response.json();

            if (data.products && data.products.length > 0) {
                data.products.forEach(product => {
                    const productHTML = createProductHTML(product, data.Category);
                    productsContainer.insertAdjacentHTML('beforeend', productHTML);
                });
                pageNum = nextPage;
            }
        } catch (error) {
            console.error('Error loading more products:', error);
        } finally {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }
    }

    // Detect when user scrolls near the bottom of the page
    window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
            loadMoreProducts();
        }
    });
</script> -->

</html>
<!-- <script>
    async function addToCart(product) {
        console.log("Product received in JS:", product);
        try {
            const response = await fetch('/add-to-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(product)
            });

            const result = await response.json();

            if (response.ok) {
                alert(`${product.ProductName} added to cart!`);
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error("Add to cart failed:", error);
            alert("Something went wrong!");
        }
    }

    // make it global
    window.addToCart = addToCart;
</script> -->

<script>
    const searchInput = document.getElementById('txt');
    const productsContainer = document.getElementById('productsContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // --- Search ---
    searchInput.addEventListener('keydown', async (event) => {
        if (event.key === 'Enter') {
            const query = searchInput.value.trim();
            if (!query) return;

            productsContainer.innerHTML = '';
            loadingIndicator.style.display = 'block';

            try {
                const res = await fetch(`/search-product?query=${encodeURIComponent(query)}`);
                const toys = await res.json();
                loadingIndicator.style.display = 'none';

                if (!toys.toys.length) {
                    productsContainer.innerHTML = '<p>No products found.</p>';
                    return;
                }

                toys.toys.forEach(product => {
                    const html = createProductHTML(product, toys.Category);
                    productsContainer.innerHTML += html;
                });
            } catch (error) {
                loadingIndicator.style.display = 'none';
                console.error('Search Error:', error);
                productsContainer.innerHTML = '<p>Something went wrong. Try again later.</p>';
            }
        }
    });

    // --- Category Dropdown ---
    document.getElementById("categoryToggle").addEventListener("click", () => {
        document.querySelector(".category-dropdown-container").classList.toggle("active");
    });

    // --- Price Slider ---
    const minSlider = document.getElementById('minRange');
    const maxSlider = document.getElementById('maxRange');
    const minPrice = document.getElementById('minPrice');
    const maxPrice = document.getElementById('maxPrice');

    minSlider.addEventListener('input', () => updateSliderDisplay());
    maxSlider.addEventListener('input', () => updateSliderDisplay());

    function updateSliderDisplay() {
        let minVal = parseInt(minSlider.value);
        let maxVal = parseInt(maxSlider.value);

        if (minVal > maxVal) {
            maxSlider.value = minVal;
            maxVal = minVal;
        }

        if (maxVal < minVal) {
            minSlider.value = maxVal;
            minVal = maxVal;
        }

        minPrice.textContent = "Rs: " + minVal + ".00";
        maxPrice.textContent = "Rs: " + maxVal + ".00";
    }

    // --- Apply Price Filter ---
    document.getElementById('btn').addEventListener('click', () => {
        const min = minSlider.value;
        const max = maxSlider.value;

        const urlParams = new URLSearchParams(window.location.search);
        const categoryParam = urlParams.get('category');

        let redirectUrl = `/alltoys?min=${min}&max=${max}`;
        if (categoryParam) {
            redirectUrl += `&category=${categoryParam}`;
        }
        console.log
        window.location.href = redirectUrl;
    });

    // --- Apply Category Filter ---
    document.getElementById('applyCategoryFilter').addEventListener('click', (e) => {
        e.preventDefault();

        const selectedCategories = [];
        document.querySelectorAll(".category-checkbox").forEach(cb => {
            if (cb.checked) selectedCategories.push(cb.value);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const minParam = urlParams.get('min');
        const maxParam = urlParams.get('max');

        let redirectUrl = '/alltoys?';
        if (selectedCategories.length > 0) {
            redirectUrl += `category=${encodeURIComponent(selectedCategories.join(','))}`;
            document.getElementById('changeByCategory').innerText = selectedCategories.join(', ');
        } else {
            redirectUrl += 'category=';
        }

        if (minParam && maxParam) {
            redirectUrl += `&min=${minParam}&max=${maxParam}`;
        }

        window.location.href = redirectUrl;
    });

    // --- Create Product HTML ---
    function createProductHTML(product, Category) {
        const finalPrice = (product.Price || 0) + (product[`Price${Category}`] || 0);
        const image = product.ProductImageURL || 'https://via.placeholder.com/200';
        const qrCode = product.qrCodeUrl || 'https://via.placeholder.com/80x80?text=QR';
        const moq = product.MinimumOrderQuantity || 'N/A';

        return `
            <div class="ims">
                <div class="containers">
                    <div class="image-container">
                        <img class="productlistimg" src="${image}" alt="${product.ProductName}">
                    </div>
                    <div class="icons">
                        <button class="addToCardBtn" onclick='addToCart(${JSON.stringify(product)})'>
                            <i class="fa fa-shopping-cart"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <h3>${product.ProductName}</h3>
                    <div class="qr-code">
                        <img class="qrcode" src="${qrCode}" alt="QR Code">
                    </div>
                    <div class="h">
                        <h4 style="color: green;">₹${Math.abs(finalPrice)}</h4>
                        <span style="font-size: 14px;">MOQ: ${moq}</span>
                    </div>
                    <a class="viewDetails" href="/toydetails/${product._id}">View Details</a>
                </div>
            </div>
        `;
    }

    // --- Infinite Scroll ---

    let isLoading = false;

    window.addEventListener('scroll', async () => {
        if (isLoading) return;

        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
            if (pageNum < totalPages) {
                isLoading = true;
                loadingIndicator.style.display = 'block';

                pageNum++; // Increment the page number for the next fetch

                try {
                    const res = await fetch(`/alltoys?page=${pageNum}`, { // Fixed URL string formatting
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json' // ✅ Tell server to send JSON
                        }
                    });

                    // Check if the response is OK
                    if (!res.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const { products } = await res.json(); // Extract 'products' from the response JSON

                    // Loop through the products and append them to the container
                    products.forEach(product => {
                        const productHTML = createProductHTML(product, ''); // You can replace '' with actual category if needed
                        productsContainer.innerHTML += productHTML; // Append the new HTML
                    });

                } catch (error) {
                    console.error('Infinite Scroll Error:', error);
                } finally {
                    isLoading = false;
                    loadingIndicator.style.display = 'none';
                }
            }
        }
    });

    // --- Add to Cart ---
    async function addToCart(product) {
        try {
            const response = await fetch('/add-to-cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(product)
            });

            const result = await response.json();
            if (response.ok) {
                alert(`${product.ProductName} added to cart!`);
            } else {
                alert(result.message);
            }
        } catch (error) {
            console.error("Add to cart failed:", error);
            alert("Something went wrong!");
        }
    }
    window.addToCart = addToCart;

</script>